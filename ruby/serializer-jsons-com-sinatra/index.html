<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
    <meta name="description" content="Aprenda a manipular suas repostas em JSONs.">
  

  <meta content="Saulo Santiago" property="og:site_name">

  
    <meta content="Serializer JSONs com Sinatra" property="og:title">
  

  
    <meta content="article" property="og:type">
  

  
    <meta content="https://saulosilva.github.io/ruby/serializer-jsons-com-sinatra" property="og:url">
  

  
    <meta content="2015-05-18T00:00:00+00:00" property="article:published_time">

    <meta content="https://saulosilva.github.io/about/" property="article:author">
  

  
    <meta content="/assets/posts/ruby/serializer-jsons-com-sinatra-big-05cc6a433eaacd80d6e3ed4f0024540a.png" property="og:image">
  

  
    
      <meta content="ruby" property="article:section">
    
  

  
    
      <meta content="API" property="article:tag">
    
      <meta content="Ruby" property="article:tag">
    
      <meta content="Sinatra" property="article:tag">
    
      <meta content="JSON" property="article:tag">
    
      <meta content="Serializer" property="article:tag">
    
      <meta content="ActiveModel Serializer" property="article:tag">
    
      <meta content="ActiveModelSerializer" property="article:tag">
    
  

  <title>
    
      Serializer JSONs com Sinatra &middot; Saulo Santiago
    
  </title>

  
    
      <link rel="alternate" type="application/rss+xml" title="" href="https://saulosilva.github.io/feed.post.xml">
    
  

  <link rel="apple-touch-icon" sizes="57x57" href="/public/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/public/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/public/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/public/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/public/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/public/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/apple-icon-180x180.png">

  <link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/public/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/public/android-icon-192x192.png">

  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/public/ms-icon-144x144.png">
  <meta name="theme-color" content="#005461">
  <meta name="application-name" content="Saulo Silva">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="#005461">
  <meta name="apple-mobile-web-app-title" content="Saulo Silva">

  <link rel="manifest" href="/public/manifest.json">

  <link rel="stylesheet" href="/assets/application-471532374005af79eebd8a3784137994.css">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63356631-1', 'auto');
  ga('send', 'pageview');
</script>
</head>

  <body>
    <nav>
  <div class="nav-wrapper">
    <a href="/" title="Home" class="brand-logo truncate">
      <img src="/assets/logo-bg-50x50-2e044dcf89bb5198e6f777ab4427f865.png" class='circle'>
      Saulo Santiago
    </a>

    <a href="#" data-activates="mobile-demo" class="button-collapse">
      <i class="mdi-navigation-menu"></i>
    </a>

    <ul id="nav-mobile" class="right hide-on-med-and-down">
      
        <li>
          <a href="http://saulosantiago.com.br">
            About
          </a>
        </li>
      
        <li>
          <a href="/ruby">
            Ruby
          </a>
        </li>
      
        <li>
          <a href="/javascript">
            Javascript
          </a>
        </li>
      
        <li>
          <a href="/feed.xml">
            Feed
          </a>
        </li>
      
    </ul>

    <ul class="side-nav" id="mobile-demo">
      
        <li>
          <a href="http://saulosantiago.com.br">
            About
          </a>
        </li>
      
        <li>
          <a href="/ruby">
            Ruby
          </a>
        </li>
      
        <li>
          <a href="/javascript">
            Javascript
          </a>
        </li>
      
        <li>
          <a href="/feed.xml">
            Feed
          </a>
        </li>
      
    </ul>
  </div>
</nav>

    <main>
      <div class='post-show z-depth-1'>
  <article class="markdown-body">
    <h1>Serializer JSONs com Sinatra</h1>
    <span class='read-time'>
      <i class='mdi-device-access-time'></i>
      Leia em: 4 minutos
    </span>

    <span class='author-info'>
      <img src="//www.gravatar.com/avatar/427733403ad646d7a164918b9da1d227?s=135" alt="Foto de Saulo Santiago" width='50' height='50' class='circle responsive-img'/>
      Escrito por: <b>Saulo Santiago</b>
    </span>

    <div class='image-big'>
      <img src="/assets/posts/ruby/serializer-jsons-com-sinatra-big-05cc6a433eaacd80d6e3ed4f0024540a.png">
    </div>

    <p>Serializar objetos em JSONs nunca foi tão fácil depois que a <a href="https://github.com/rails-api/active_model_serializers"><code>gem ActiveModel::Serializers</code></a> passou a existir. </p>

<p>A gem <strong>facilita a manipulação dos objetos Ruby para objetos JSONs.</strong></p>

<p>Com isso podemos dedicar um lugar para personalizar totalmente a saída desses objetos. Para cada objeto que queremos serializar devemos criar um arquivo que contenha uma classe que estenda de <code>ActiveModel::Serializer</code>.</p>

<p>Imagine que o <code>controller</code> receba um objeto com a seguinte estrutura:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#&lt;Foo id: 1, foo: &quot;foo&quot;, bar: &quot;bar&quot;, baz: &quot;baz&quot;&gt;</span>
</code></pre></div>
<p>Mas você eu não estou satisfeito em devolver todos atributos na resposta. Qual seria a solução para isto?</p>

<p>A solução é manipular este objeto usando uma classe serializer. Desejo que ele tenha apenas o atributo <code>bar</code>. Para que isto seja possível dexei o serializer da seguinte maneira:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">FooSerializer</span> <span class="o">&lt;</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Serializer</span>
  <span class="n">attributes</span> <span class="ss">:bar</span>
<span class="k">end</span>
</code></pre></div>
<p>Se estiver utilizando o <strong>framework <a href="https://github.com/rails/rails">Rails</a></strong> basta fazer um <code>render</code> do tipo <code>json</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">show</span>
  <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="no">Foo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>e teremos este retorno:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;bar&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
  <span class="p">}</span>  
<span class="p">}</span>
</code></pre></div>
<p>Perfeito, tudo funcionou como desejavamos.</p>

<h4>Conhecendo um pouco mais a Gem</h4>

<p>Você deve ter achado esquisito (<strong>automatico</strong>) em fazer apenas um <code>render</code> e ele trazer um objeto serializado sem precisar especificar nada de onde pegar.</p>

<p>Pois bem esta magia acontece dentro da <code>gem</code>, como podemos <a href="https://github.com/rails-api/active_model_serializers/blob/v0.9.3/lib/action_controller/serialization.rb#L48">ver aqui</a>, ele intercepta todos os <code>renders</code> do tipo <code>json</code>, depois <a href="https://github.com/rails-api/active_model_serializers/blob/v0.9.3/lib/action_controller/serialization.rb#L71">procura pelo serializer</a> que tenha o mesmo nome do objeto e finaliza devolvendo a <a href="https://github.com/rails-api/active_model_serializers/blob/v0.9.3/lib/action_controller/serialization.rb#L95">instância desta classe</a> no formato JSON.</p>

<p>Genial, não? </p>

<p>Se sua resposta foi sim, concordo plenamente contigo. Mas pena que isto só funciona para o Rails.</p>

<h2>Solução para o Sinatra</h2>

<p>Meses atras passei por esta dificuldade. Precisei utilizar o <code>ActiveModel::Serializers</code> em uma APP feita em Sinatra e tive problemas em deixar as resposta em <code>JSONs</code> serializadas de forma automatica, como ocorre no Rails.</p>

<p>O problema é que no Sinatra não oferece suporte para a classe <code>ActionController</code>, sendo assim a gem lança o seguinte erro <code>cannot load such file -- action_controller (LoadError)</code> ao tentar carregar, mas este erro é <a href="https://github.com/rails-api/active_model_serializers/blob/v0.9.3/lib/active_model_serializers.rb#L18-L20">tratado</a> para que nossa aplicação não pare de funcionar.</p>

<p>Sendo assim que fazer esse trabalho manualmente, ficando da seguinte forma:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">get</span> <span class="s1">&#39;/foo/:id&#39;</span> <span class="k">do</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="n">json</span> <span class="no">FooSerializer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span>
</code></pre></div>
<p>Não podemos dizer que isto não seja uma solução válida, mas se você achou que da pra melhorar, eu concordo contigo.</p>

<p>Vendo essa necessidade, criei esta <a href="https://github.com/SauloSilva/sinatra-active-model-serializers/"><code>gem sinatra-active-model-serializers</code></a> para deixar tudo isso automatico no Sinatra também, assim como é no Rails.</p>

<p>E o resultado disto ficou:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">get</span> <span class="s1">&#39;/foo/:id&#39;</span> <span class="k">do</span>
  <span class="n">json</span> <span class="no">Foo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Para que estas adaptações funcione como no exemplo acima você deverá instalar a gem: <code>gem install sinatra-active-model-serializers</code> ou adicionar em seu Gemfile: <code>gem &#39;sinatra-active-model-serializers&#39;</code>.</p>

<p>Essa <code>gem</code> basicamente aplica toda a lógica de controller feita para o Rails no módulo <a href="https://github.com/SauloSilva/sinatra-active-model-serializers/blob/v0.0.3/lib/sinatra-active-model-serializers/json.rb#L4"><code>JSON</code></a> do Sinatra com algumas opções caso queira personalizar mais ainda suas respostas.</p>

<p>Maiores detalhes você encontrará <a href="https://github.com/SauloSilva/sinatra-active-model-serializers#requirements">aqui nas espeficicações da gem.</a></p>

  </article>

  <div class="share-page">
    <div class='social'>
      <b>
        Share this on &rarr;
      </b>
    </div>

    <div class='social'>
      <a href="https://facebook.com/sharer.php?u=https://saulosilva.github.io/ruby/serializer-jsons-com-sinatra" rel="nofollow" target="_blank" title="Share on Facebook" class='button-facebook waves-effect waves-light btn'>Facebook</a>
    </div>

    <div class='social'>
      <a href="https://plus.google.com/share?url=https://saulosilva.github.io/ruby/serializer-jsons-com-sinatra" rel="nofollow" target="_blank" title="Share on Google+" class='button-googleplus waves-effect waves-light btn'>Google+</a>
    </div>

    <div class='social'>
      <a href="https://twitter.com/intent/tweet?text=Serializer JSONs com Sinatra&url=https://saulosilva.github.io/ruby/serializer-jsons-com-sinatra&via=SSILVASANTIAGO&related=SSILVASANTIAGO" rel="nofollow" target="_blank" title="Share on Twitter" class='button-twitter waves-effect waves-light btn'>Twitter</a>
    </div>

    <div class='social'>
      <a href="http://www.reddit.com/submit?url=https://saulosilva.github.io&title=Serializer JSONs com Sinatra" class='button-reddit waves-effect waves-light btn' target="_blank">Reddit</a>
    </div>

    <div class='social'>
      <a href="http://www.linkedin.com/shareArticle?mini=true&url=https://saulosilva.github.io&title=Serializer JSONs com Sinatra&summary=Aprenda a manipular suas repostas em JSONs.&source=https://saulosilva.github.io" class='button-linkedin waves-effect waves-light btn' target="_blank">Linkedin</a>
    </div>
</div>
  
  <div class='comments'>
    <h2>Comentários:</h2>
    <span>
      <i class='mdi-editor-insert-comment'></i>
      Deixe sua dúvida, sugestão ou crítica, estou ancioso para saber tudo que você achou sobre este post:
    </span>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'saulosantiago';

        (function() {
            var dsq = document.createElement('script');

            dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>

</div>
    </main>

    <footer class='page-footer'>
  <div class="container">

    <div class="row">
      <div class="col s12 m6">
        <h5 class="white-text">Quem sou?</h5>
        <p class="grey-text text-lighten-4">
          Desenvolvedor Ruby e Javascript.</br>
          Trabalho há 6 anos com sistemas web.</br>
          Meu maior combustível é a cafeína.
        </p>
      </div>

      <div class="col s12 m6 center-align tecnologies">
        <img src="/assets/ruby-50x50-d57c05debca929fb451f7ec41b2aeac0.png">
        <img src="/assets/node-50x50-d5171f83410aff45c1b1433d1fb5b50e.png">
        <img src="/assets/html5-50x50-704155102b094841fab5931c4ac7e5b5.png">
        <img src="/assets/js-50x50-f2c9ff199a14ba2e53500957ad7da9a4.png">
        <img src="/assets/css3-50x50-27549afca5ba2f59ec7a9475c41ab788.png">
        <img src="/assets/backbonejs-50x50-2fc8d8e7c4c8e49c28880d005ab8836f.png">
        <img src="/assets/marionettejs-50x50-40fc1fc2255d160ed9a67e918226af1b.png">
        <img src="/assets/emberjs-50x50-2f88606d6fda59584a2a820e11796692.png">
        <img src="/assets/angular-50x50-6408004c5b588b8c8d86c3a20d0162cc.png">
        <img src="/assets/nginx-50x50-a2043f3e2b11a9c6080f6f8989fe6d18.png">
      </div>
    </div>
  </div>

  <div class="footer-copyright">
    <div class="container">
      &copy; 2015. All rights reserved for Saulo Santiago.
    </div>
  </div>
</footer>
  </body>

  <script src="/assets/application-d5c002228b1694b38b44d49a59b4b9a9.js"></script>
</html>